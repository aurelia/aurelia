name: main
on:
  push:
    # check against refs/heads
    branches-ignore:
      - develop
      - release
    paths-ignore:
      - 'docs/**'

env:
  PREFERRED_WORKSPACE_MANAGER: yarn # for lage to work property

jobs:

  lint:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: 15
      - run: npm ci
      - run: npm run build
      - run: npm run lint:packages:ci
      - run: npm run lint:other:ci

  # Only turn on if necessary per branch
  #
  # node:
  #   timeout-minutes: 10
  #   strategy:
  #     matrix:
  #       suite: [
  #         "kernel",
  #         "runtime",
  #         "runtime-html",
  #         "router",
  #         "router-lite",
  #         "i18n",
  #         "validation",
  #       ]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: actions/setup-node@v1
  #       with:
  #         node-version: 15
  #     - run: npm ci
  #     - run: npm run rollup
  #     - run: npm run test-node:${{matrix.suite}}
  #       working-directory: packages/__tests__

  # test-packages-cjs:
  #   timeout-minutes: 10
  #   strategy:
  #     matrix:
  #       suite: [
  #         "aot",
  #         "babel-jest",
  #         "plugin-conventions",
  #         "plugin-gulp",
  #         "ts-jest",
  #         "webpack-loader",
  #       ]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: actions/setup-node@v1
  #       with:
  #         node-version: 15
  #     - run: npm ci
  #     - run: npm run build
  #     - run: npm run change-tsconfigs:invert
  #     - run: npm run build
  #     - run: npm run change-tsconfigs:restore
  #     - run: npm run change-package-refs:release -- commonjs
  #     - run: npm run test-node:${{matrix.suite}}
  #       working-directory: packages-cjs/__tests__

  router-e2e:
    runs-on: ubuntu-latest
    container:
      image: "circleci/node:16.3.0-buster-browsers"
      options: --user 1001
    steps:
      - uses: actions/checkout@v2
      - run: npm ci
      - run: npm run build
        name: build all packages
      - run: npm run test:ci
        name: build e2e projects
        working-directory: packages/__e2e__/router-configured-basic

  packages:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    container:
      image: "circleci/node:15.4.0-buster-browsers"
      options: --user 1001
    strategy:
      matrix:
        browser: ["chrome", "firefox"]
    steps:
      - uses: actions/checkout@v2
      - run: npm ci
      - run: npm run build:test
      - run: npm run test-${{matrix.browser}}
        working-directory: packages/__tests__

  packages-in-node:
    name: packages (node)
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: 15
      - run: npm ci
      - run: npm run build:test
      - run: npm run test-node
        working-directory: packages/__tests__

  packages-cjs:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: 15
      - run: npm ci
      - run: npm run build
      - run: npm run change-tsconfigs:invert
      - run: npm run build
      - run: npm run change-tsconfigs:restore
      - run: npm run change-package-refs:release -- commonjs
      - run: npm run test-node
        working-directory: packages-cjs/__tests__

  example-apps:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    container:
      image: "circleci/node:15.4.0-buster-browsers"
      options: --user 1001
    steps:
      - uses: actions/checkout@v2
      - run: npm ci
      - run: npm run build
      - name: Helloworld size check
        run: npm run build
        working-directory: examples/helloworld
      - name: Inferno 1kcomponents perf + svg build check
        run: npm run build
        working-directory: examples/1kcomponents
      - name: Fractals tree perf + svg build check
        run: npm run build
        working-directory: examples/fractals-tree
      - name: Sierpinski triangle build check
        run: npm run build
        working-directory: examples/sierpinski-triangle

  # benchmark using playwright setup
  benchmark_playwright:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    container:
      image: "circleci/node:15.4.0-buster-browsers"
      options: --user 1001
    steps:
      - checkout
      - run: git checkout master
      - run: CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
      - run: npm ci
      - run: npm run build
      - run:
          name: "Run test for the master branch"
          # TODO(Sayan): remove the duplication of config, which was done for backward compatibility, and can be removed once PR #1094 is merged with master.
          command: |
            cd test/benchmarking-apps/runner
            set -o pipefail && node dist/run-benchmarks --i 2 --storage json
      - run: cd ../../../
      - run: echo "checking out current branch"
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - run: npm ci
      - run: npm run build
      - run:
          name: "Run test for the current branch"
          command: |
            cd test/benchmarking-apps/runner
            set -o pipefail && node dist/run-benchmarks --i 2 --storage json
      # source: https://support.circleci.com/hc/en-us/articles/360048170573-Auto-comment-on-GitHub-Pull-Requests
      # - run:
      #     name: Post benchmarking comparison link to GitHub PR
      #     command: |
      #       sudo apt-get install jq

      #       pr_response=$(curl --location --request GET "https://api.github.com/repos/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/pulls?head=$CIRCLE_PROJECT_USERNAME:$CIRCLE_BRANCH" -H "Authorization: token $GITHUB_TOKEN")

      #       if [ $(echo $pr_response | jq length) -eq 0 ]; then
      #         echo "No PR found to update"
      #       else
      #         pr_comment_url=$(echo $pr_response | jq -r ".[]._links.comments.href")

      #         git checkout master
      #         master_commit=$(git rev-parse HEAD)

      #         comparison_url="https://au2-bench-viewer.azurewebsites.net/compare?branch=master&commit=$master_commit&branch=$CIRCLE_BRANCH&commit=$CIRCLE_SHA1"
      #         curl --location --request POST "$pr_comment_url" \
      #         -H 'Content-Type: application/json' \
      #         -H "Authorization: token $GITHUB_TOKEN" \
      #         --data-raw "{
      #         \"body\": \"The benchmarking comparison can be found here: $comparison_url\"
      #         }"
      #       fi