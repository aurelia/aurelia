name: Release (manual)

on:
  workflow_dispatch:
    inputs:
      lane:
        description: "Which lane to publish?"
        type: choice
        options: [auto, dev, latest]
        default: auto
      dry_run:
        description: "Plan only (open/update Version PR); do not publish"
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      HUSKY: "0"
      HUSKY_SKIP_HOOKS: "1"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org
          cache: npm

      - run: npm ci

      # Safety check: verify internal dependencies are consistent
      # This catches manual version changes that bypassed changesets
      - name: Verify internal dependency consistency
        run: node scripts/check-internal-deps.cjs

      - name: Decide lane
        id: decide
        shell: bash
        run: |
          # detect pre-mode by presence of .changeset/pre.json
          if [ -f .changeset/pre.json ]; then PRE=on; else PRE=off; fi

          # normalize input -> effective lane
          case "${{ inputs.lane }}" in
            dev)    LANE=dev ;;
            latest) LANE=latest ;;
            auto)   if [ "$PRE" = "on" ]; then LANE=dev; else LANE=latest; fi ;;
          esac

          echo "pre=$PRE"   >> "$GITHUB_OUTPUT"
          echo "lane=$LANE" >> "$GITHUB_OUTPUT"

      - run: npm run build:release

      # -------------------------------
      # PLAN PHASE (no publish)
      # -------------------------------
      # On dry_run, create/update the Version PR with a clean summary.
      - name: Check for pending changesets
        if: ${{ inputs.dry_run }}
        id: check-changesets
        run: |
          CHANGESET_COUNT=$(ls -1 .changeset/*.md 2>/dev/null | grep -v README.md | wc -l || echo 0)
          echo "count=$CHANGESET_COUNT" >> "$GITHUB_OUTPUT"
          if [ "$CHANGESET_COUNT" -gt 0 ]; then
            echo "has_changesets=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changesets=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate release summary (before versioning)
        if: ${{ inputs.dry_run && steps.check-changesets.outputs.has_changesets == 'true' }}
        id: summary
        run: |
          # Generate the clean summary from pending changesets
          SUMMARY=$(node .changeset/generate-release-summary.cjs)
          # Write to file for PR body (handles multiline properly)
          echo "$SUMMARY" > /tmp/pr-body.md

      - name: Run changeset version
        if: ${{ inputs.dry_run && steps.check-changesets.outputs.has_changesets == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx changeset version

      - name: Get new version
        if: ${{ inputs.dry_run && steps.check-changesets.outputs.has_changesets == 'true' }}
        id: version
        run: |
          VERSION=$(node -p "require('./packages/aurelia/package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create or update Version PR
        if: ${{ inputs.dry_run && steps.check-changesets.outputs.has_changesets == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="changeset-release/master"
          TITLE="release(${{ steps.decide.outputs.lane }}): version packages (${{ steps.version.outputs.version }})"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if branch exists on remote
          if git ls-remote --exit-code origin "$BRANCH" >/dev/null 2>&1; then
            # Branch exists - update it
            git checkout -B "$BRANCH"
            git add -A
            git commit -m "ci(release): version packages (${{ steps.decide.outputs.lane }})" || echo "No changes to commit"
            git push origin "$BRANCH" --force
            # Update existing PR or create a new one if none is open
            PR_NUMBER=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number')
            if [ -n "$PR_NUMBER" ]; then
              gh pr edit "$PR_NUMBER" --title "$TITLE" --body-file /tmp/pr-body.md
              echo "Updated PR #$PR_NUMBER"
            else
              gh pr create \
                --base master \
                --head "$BRANCH" \
                --title "$TITLE" \
                --body-file /tmp/pr-body.md
            fi
          else
            # Branch doesn't exist - create it and new PR
            git checkout -b "$BRANCH"
            git add -A
            git commit -m "ci(release): version packages (${{ steps.decide.outputs.lane }})"
            git push origin "$BRANCH"
            gh pr create \
              --base master \
              --head "$BRANCH" \
              --title "$TITLE" \
              --body-file /tmp/pr-body.md
          fi

      - name: No changesets to version
        if: ${{ inputs.dry_run && steps.check-changesets.outputs.has_changesets == 'false' }}
        run: |
          echo "No pending changesets found. Nothing to version."
          echo "If you expected changesets, make sure they have been added and pushed."

      # -------------------------------
      # PUBLISH PHASE (actual publish)
      # -------------------------------
      # When NOT dry_run, publish according to the decided lane.
      - name: Changesets – prerelease publish
        if: ${{ !inputs.dry_run && steps.decide.outputs.lane == 'dev' }}
        uses: changesets/action@v1
        with:
          publish: npm run changeset:publish
          title: "release(prerelease): version packages"
          commit: "ci(release): version packages (prerelease)"
          createGithubReleases: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Changesets – stable publish (latest)
        if: ${{ !inputs.dry_run && steps.decide.outputs.lane == 'latest' }}
        uses: changesets/action@v1
        with:
          publish: npm run changeset:publish
          title: "release: version packages"
          commit: "ci(release): version packages (latest)"
          createGithubReleases: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
