# Release Workflow Reference

> AI-generated reference document capturing release infrastructure knowledge.
> Last updated: 2026-01-13 (rc-1 preparation session)

## Quick Reference

```bash
# Check changeset status
npx changeset status

# Check pre-release mode
cat .changeset/pre.json | grep -E '"(mode|tag)"'

# Check npm dist-tags
npm view aurelia dist-tags
```

---

## Changesets Configuration

### Config File: `.changeset/config.json`

```json
{
  "changelog": ["./changelog.cjs", { "repo": "aurelia/aurelia" }],
  "commit": false,
  "access": "public",
  "baseBranch": "master",
  "updateInternalDependencies": "patch",
  "fixed": [[ /* 31 public packages - all version together */ ]],
  "ignore": ["@__e2e__/*", "@examples/*", "@aurelia/__tests__", ...],
  "privatePackages": { "version": false, "tag": false }
}
```

**Key points:**
- `fixed` array: All packages version together (lockstep)
- `ignore` array: e2e, examples, tests excluded
- `privatePackages.version: false`: Private packages (like `@aurelia/addons`) don't get versioned
- Root `@aurelia/monorepo` is NOT in `fixed`, so it drifts (manually synced via hook)
- Changelog entries are generated by `scripts/changeset-version.cjs` into `docs/CHANGELOG.md`
- Per-package `CHANGELOG.md` files are generated by Changesets using `.changeset/changelog.cjs` (dependency lines suppressed)

### Pre-release Mode: `.changeset/pre.json`

When in pre-release mode, this file exists:

```json
{
  "mode": "pre",           // "pre" = active, "exit" = transitioning out
  "tag": "rc",             // npm dist-tag: beta, rc, dev, etc.
  "initialVersions": {},   // Snapshot of versions when entering pre-mode
  "changesets": []         // Consumed changesets (NOT deleted until exit)
}
```

**Critical behavior in pre-mode:**
- Changeset `.md` files are NOT deleted when consumed
- They're tracked in `changesets` array
- Files only deleted when exiting pre-mode AND running `changeset version`

---

## GitHub Workflows

### `release.yml` (Manual)

**Purpose:** Version packages and/or publish to npm

**Inputs:**
- `lane`: auto | dev | latest (auto detects from pre.json presence)
- `dry_run`: true = only create Version PR, false = may publish

**How `changesets/action` works (two modes):**

| Changesets Pending? | Action |
|---------------------|--------|
| Yes | Runs `changeset version`, creates Version PR, does NOT publish |
| No | Runs `publish` command, publishes to npm |

**Important:** Two workflow runs needed to publish:
1. First run (changesets exist) → Creates Version PR
2. Merge PR
3. Second run (no changesets) → Publishes

**Note:** Workflow runs `npm run changeset:version`, so the wrapper script and `postchangeset:version` hook both run.
**PR body:** Uses `.changeset/generate-release-summary.cjs` (deduped summary + affected packages).

### `dev-prerelease.yml` (Manual)

**Purpose:** Enter or exit pre-release mode

**Inputs:**
- `action`: enter | exit
- `tag`: Pre-release tag when entering (beta, rc, dev)

**Creates PR with:**
- Modified/created `pre.json`
- Does NOT run `changeset version`

### `add-latest-tags.yml` (Manual)

**Purpose:** Tag a prerelease version as `@latest` on npm

**Input:** `version` (e.g., "2.0.0-rc.0")

**Why needed:** Changesets publishes prereleases to their tag (@beta, @rc), not @latest. This workflow manually adds the @latest tag.

**Package list:** Hardcoded 31 packages - verify matches `config.json` fixed array if packages added/removed.

---

## Version Bump Behavior

### In Pre-release Mode

| Changeset Type | Example Bump |
|----------------|--------------|
| patch | 2.0.0-rc.0 → 2.0.0-rc.1 |
| minor | 2.0.0-rc.0 → 2.0.0-rc.1 (same as patch) |
| major | 2.0.0-rc.0 → 3.0.0-rc.0 (!) |

**Warning:** Major changesets in pre-mode bump the major version! Downgrade to minor if staying in same major.

### Transitioning Pre-release Tags (e.g., beta → rc)

```bash
npx changeset pre exit      # Sets mode="exit", keeps files
npx changeset pre enter rc  # Creates new pre.json with tag="rc"
```

**Gotcha:** Consumed changesets from old mode remain in `changesets` array. Can manually clear if transitioning without stable release:
1. Delete stale changeset files listed in `changesets` array
2. Clear the array: `"changesets": []`

---

## npm Dist-Tags

| Tag | Purpose |
|-----|---------|
| `@latest` | Default install, typically stable or promoted prerelease |
| `@beta` | Beta prereleases |
| `@rc` | Release candidate prereleases |
| `@dev` | Development prereleases |

Changesets publishes to tag based on `pre.json.tag`. Use `add-latest-tags.yml` to also tag as @latest.

---

## Common Procedures

### Release RC-0 (from beta)

```bash
# 1. Ensure changesets are minor (not major) for same major version
npx changeset status  # Check bump types

# 2. Switch pre-mode from beta to rc
npx changeset pre exit
npx changeset pre enter rc

# 3. Clean up stale changesets if needed
# (Delete files in old pre.json.changesets array, clear array)

# 4. Commit and push

# 5. Run release.yml workflow → Creates Version PR

# 6. Merge PR

# 7. Run release.yml workflow again → Publishes to npm @rc

# 8. Optionally run add-latest-tags.yml to tag as @latest
```

### Release RC-1, RC-2, etc.

```bash
# 1. New changesets added by developers

# 2. Run release.yml → Version PR (bumps rc.0 → rc.1)

# 3. Merge PR

# 4. Run release.yml → Publishes

# 5. Optionally tag as @latest
```

### Release Stable 2.0.0 (exit pre-mode)

```bash
# 1. Exit pre-mode
npx changeset pre exit
# OR via dev-prerelease.yml workflow

# 2. Run release.yml → Version PR
#    - Bumps 2.0.0-rc.X → 2.0.0
#    - Deletes pre.json
#    - Deletes all tracked changeset files

# 3. Merge PR

# 4. Run release.yml → Publishes to @latest
```

---

## Known Issues / Gotchas

### Root package.json Version Drift

- Root `@aurelia/monorepo` is private and not in `fixed` array
- Changesets doesn't update it
- `postchangeset:version` hook syncs it from `packages/aurelia` (local only)
- Workflow doesn't run the hook, so PRs may have drifted root version

### Two Workflow Runs to Publish

The `changesets/action` behavior means you need:
1. Run workflow → Version PR created
2. Merge PR
3. Run workflow again → Publishes

This is intentional (allows review) but can be confusing.

### Changeset Files Accumulate in Pre-mode

Changeset `.md` files are NOT deleted during pre-release versioning. They accumulate until exiting pre-mode. This is expected behavior.

### Workflow vs Local Versioning

| Command | Hook Runs? | Root Synced? | Tag Created? |
|---------|-----------|--------------|--------------|
| `npm run changeset:version` | Yes | Yes | Yes |
| `changeset version` (direct) | No | No | No |
| Workflow (changesets/action) | No | No | No |

### Package Lists to Keep in Sync

If packages are added/removed:
1. `.changeset/config.json` → `fixed` array
2. `.github/workflows/add-latest-tags.yml` → `PACKAGES` array

---

## File Locations

```
.changeset/
├── config.json          # Changesets configuration
├── pre.json             # Pre-release mode state (when active)
└── *.md                 # Pending changesets

.github/workflows/
├── release.yml          # Version + publish workflow
├── dev-prerelease.yml   # Enter/exit pre-release mode
└── add-latest-tags.yml  # Tag prerelease as @latest

package.json             # Root - has postchangeset:version hook
```

---

## Debugging

```bash
# What version will be published?
npx changeset status

# What's the current pre-release state?
cat .changeset/pre.json

# What's on npm?
npm view aurelia dist-tags
npm view @aurelia/kernel versions --json | tail -20

# Recent release workflow runs
gh run list --workflow=release.yml --limit=5

# Check if changeset was consumed (in pre-mode)
cat .changeset/pre.json | jq '.changesets'
```
