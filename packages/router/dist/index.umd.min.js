(function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("@aurelia/runtime"),require("@aurelia/kernel")):"function"==typeof define&&define.amd?define(["exports","@aurelia/runtime","@aurelia/kernel"],s):s((t=t||self).router={},t.runtime,t.kernel)})(this,function(t,runtime,kernel){"use strict";function s(t){const s={},i=[];if(!t||!t.length)return{t:s,list:i};const h=t.replace("+"," ").split("&");for(const t of h){const h=t.split("="),e=decodeURIComponent(h.shift());if(!h.length){i.push(e);continue}const value=decodeURIComponent(h.shift());s[e]=value}return{t:s,list:i}}function i(t,s,i,h){var e,n,r=arguments.length,o=3>r?s:null===h?h=Object.getOwnPropertyDescriptor(s,i):h;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,s,i,h);else for(n=t.length-1;n>=0;n--)(e=t[n])&&(o=(3>r?e(o):r>3?e(s,i,o):e(s,i))||o);return r>3&&o&&Object.defineProperty(s,i,o),o}class h{constructor(){this.s=(()=>{if(null!==this.i){const t=this.i;return this.i=null,void t()}const t=this.h(),s=this.o(),i={};let h,e=this.l("HistoryEntry");if(this.u&&this.u.path===t){i.p=1;const t=this.v?this.m.index:this.history.length-this.g;h=this.m,this.m=this.u,this.m.index=t,this.v?(this.$=0,this.O[this.m.index]=this.m,this.C?(i.j=1,this.C=0):this.R?(i.k=1,this.R=0):i.P=1,this.v=0):(this.$=1,this.O=this.O.slice(0,this.m.index),this.O.push(this.m)),this.S({H:this.O,V:this.g,N:this.m})}else this.O=this.O||this.l("HistoryEntries")||[],this.g=this.g||this.l("HistoryOffset")||0,e||this.m?e?this.m?e.index>this.m.index?i.A=1:this.m.index>e.index&&(i.I=1):i.k=1:i.p=1:(i.p=1,i.T=1,this.g=this.history.length),e||(this.O=this.O.slice(0,(e={path:t,q:null,index:this.history.length-this.g,_:s}).index),this.O.push(e),this.S({H:this.O,V:this.g,N:e})),this.$=this.m?e.index-this.m.index:0,h=this.m,this.m=e,this.C&&(i.j=1,this.C=0);this.u=null,this.F&&this.F--,this.J(this.m,i,h)}),this.location=window.location,this.history=window.history,this.m=null,this.O=null,this.g=null,this.L=null,this.u=null,this.options=null,this.D=0,this.$=null,this.F=null,this.C=0,this.v=0,this.R=0,this.i=null}U(t){if(this.D)throw Error("History has already been activated.");return this.D=1,this.options=Object.assign({},t),window.addEventListener("popstate",this.s),Promise.resolve().then(()=>{this.M(this.h(),1)})}B(){window.removeEventListener("popstate",this.s),this.D=0}W(t,s,i){this.u={path:t,q:null,title:s,data:i},this.M(t)}replace(t,s,i){this.v=1,this.u={path:t,q:null,title:s,data:i},this.M(t,1)}G(t,s,i){this.F=this.$+1,this.replace(t,s,i)}refresh(){this.m&&(this.R=1,this.replace(this.m.path,this.m.title,this.m.data))}back(){this.history.go(-1)}forward(){this.history.go(1)}cancel(){this.C=1;const t=this.$||this.F;t?this.history.go(-t):this.replace(this.L.path,this.L.title,this.L.data)}async pop(){let t,s=new Promise(t=>{this.i=t});this.history.go(-1),await s;const i=""+this.location;t=this.history.state,s=new Promise(t=>{this.i=t}),this.history.go(-1),await s,this.history.pushState(t,null,i)}S(t,value){const{pathname:s,search:i,hash:h}=this.location;let e=Object.assign({},this.history.state);"string"==typeof t?e[t]=JSON.parse(JSON.stringify(value)):e=Object.assign({},e,JSON.parse(JSON.stringify(t))),this.history.replaceState(e,null,`${s}${i}${h}`)}l(t){return Object.assign({},this.history.state)[t]}K(t){this.m.title=t,this.O[this.m.index]=this.m,this.S({H:this.O,N:this.m})}X(t,s,i){if(i.index!==this.m.index)return;const h=`#/${t}`,{pathname:e,search:n,hash:r}=this.location;if(h===r&&this.m.path===t&&this.m.q===s)return;this.m.path=t,this.m.q=s;const o=Object.assign({},this.history.state,{N:this.m,H:this.O});this.history.replaceState(o,null,`${e}${n}${h}`)}Y(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get Z(){return this.O?this.O.slice(0,this.m.index+1).map(value=>value.title):[]}h(){return this.location.hash.substring(1).split("?")[0]}M(t,s=0){if(this.m&&this.m.path===t&&!this.R)return;const{pathname:i,search:h}=this.location,e=`#${t}`;s?(this.L=this.m,this.history.replaceState({},null,`${i}${h}${e}`)):this.history.pushState({},null,`${i}${h}${e}`),this.s()}o(){const t=this.location.hash.substring(1).split("?");return t.shift(),t.length>0?t.shift():""}J(t,s,i){const h=Object.assign({},t,s);h.tt=i,this.options.J&&this.options.J(h)}}class e{constructor(){this.D=0,this.st=(t=>{const s=e.it(t);s.ht&&(t.preventDefault(),this.options.J(s))}),this.document=document}static it(t){const s={ht:0,href:null,anchor:null},i=e.et(t.target);if(!i||!e.nt(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const h=i.getAttribute("href");return s.anchor=i,s.href=h,s.ht=1===t.which,s}static et(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static nt(t){const s=t.getAttribute("target");return!s||s===e.window.name||"_self"===s}U(t){if(this.D)throw Error("LinkHandler has already been activated.");this.D=1,this.options=Object.assign({},t),this.document.addEventListener("click",this.st,1)}B(){this.document.removeEventListener("click",this.st,1),this.D=0}}class n{constructor(t,s){this.active="",this.rt=t,Object.assign(this,{ot:s.ot,title:s.title,children:null,lt:s.lt,active:""}),this.link=this.ct(this.ot),this.at=s.ut?this.ct(s.ut):this.link,this.ft=this.rt.router.dt.get(runtime.IObserverLocator),this.pt=this.ft.vt(0,this.rt.router,"activeComponents"),this.pt.subscribe(this)}get wt(){return this.children&&this.children.length?"nav-has-children":""}gt(){this.active=this.link&&this.link.length?this.$t():"nav-active"===this.active?"nav-active":this.yt()?"nav-active-child":""}$t(){const t=this.at.split(this.rt.router.bt.add),s=this.rt.router.Ot;for(const component of t)if(0>component.indexOf(this.rt.router.bt.viewport)){if(0>s.findIndex(value=>value.replace(/\@[^=]*/,"")===component))return""}else if(0>s.indexOf(component))return"";return"nav-active"}Ct(){this.active=this.active.startsWith("nav-active")?"":"nav-active"}ct(t){return Array.isArray(t)?t.map(value=>this.Et(value)).join(this.rt.router.bt.jt):this.Et(t)}yt(){if(this.children)for(const t of this.children)if(t.active.startsWith("nav-active")||t.yt())return 1;return 0}Et(component){return component?"string"==typeof component?component:component.description?component.description.name:component.component?this.Et(component.component)+(component.viewport?`@${component.viewport}`:""):void 0:""}}class r{constructor(router,name){this.router=router,this.name=name,this.Rt=[]}kt(t){for(const s of t)this.Pt(this.Rt,s)}Pt(t,s){const i=new n(this,s);if(t.push(i),s.children){i.children=[];for(const t of s.children)this.Pt(i.children,t)}}}class o{constructor(t,s){this.st=t,this.names=s}}class l{constructor(t,s){this.St=t,this.Ht=s}}class c{constructor(){this.Vt=0,this.xt=0,this.Nt=0}}class a{constructor(t,s,i){this.st=t,this.At=s,this.It=i}}class u{constructor(t,s,i){this.Tt=t,this.qt=s,this.repeat=i}_t(t){return this.qt===t.qt&&this.Tt===t.Tt}}class State{constructor(t){this.Ft=t,this.Jt=[]}put(t){let s=this.Jt.find(s=>s.Ft._t(t));return void 0===s&&(s=new State(t),this.Jt.push(s),t.repeat&&s.Jt.push(s)),s}}const f=/(\/|\.|\*|\+|\?|\||\(|\)|\[|\]|\{|\}|\\)/g;class d{constructor(t,s){this.name=t,this.Lt=t,this.zt=s,this.optional=0}Dt(t){const s=this.Lt,i=s.length;let h=0,e="";if(this.zt)for(;i>h;++h)e=s.charAt(h),t(new u(null,e,0));else for(;i>h;++h)e=s.charAt(h),t(new u(null,e.toUpperCase()+e.toLowerCase(),0))}Ut(){return this.Lt.replace(f,"\\$1")}Mt(t,s){return this.Lt}}class p{constructor(name,optional){this.name=name,this.optional=optional}Dt(t){t(new u("/",null,1))}Ut(){return"([^/]+)"}Mt(t,s){return s[this.name]=1,t[this.name]}}class v{constructor(name){this.name=name,this.optional=0}Dt(t){t(new u("",null,1))}Ut(){return"(.+)"}Mt(t,s){return s[this.name]=1,t[this.name]}}class w{Dt(t){}Ut(){return""}Mt(t,s){return""}}class m{constructor(router,name,t,s,i,h,e){this.router=router,this.name=name,this.Bt=t,this.context=s,this.Wt=i,this.scope=h,this.options=e,this.clear=0,this.content=null,this.Gt=null,this.t=null,this.Kt=null,this.Qt=null,this.Xt=null,this.component=null,this.Yt=null,this.Zt=null,this.ts=null,this.ss=0}hs(t,s){let i;if(this.clear=0,"string"==typeof t)if(t===this.router.bt.clear)this.clear=1,t=null;else{const s=t.split(this.router.bt.t);t=s.shift(),i=s.length?s.join(this.router.bt.t):null,this.context&&(t=this.es(t))}return this.Gt=t,this.Xt=s,this.Kt=i,this.ss=0,"string"==typeof t&&this.ns(this.content)!==t||"string"!=typeof t&&this.content!==t||this.t!==i||!this.Qt||this.Qt._!==s._||s.k?1:0}rs(t,s,i){this.scope&&this.scope.parent&&!this.scope.viewport&&(this.scope.viewport=this),this.scope&&!this.scope.Bt&&(this.scope.Bt=t),this.Bt!==t&&(this.ts=Object.assign({},this),this.os(),this.Bt=t,i&&i.ls&&(this.options.ls=i.ls),i&&i.default&&(this.options.default=i.default),i&&i.cs&&(this.options.cs=i.cs),i&&i.as&&(this.options.as=i.as),this.Zt&&this.Zt()),this.context!==s&&(this.context=s),this.component||this.Yt||!this.options.default||this.router.us(this,this.options.default)}remove(t,s){return this.Bt===t&&this.context===s}async fs(){if(!this.component)return 1;const component=this.component;return component.fs?component.fs(this.Qt,this.Xt):1}async ds(){if(this.clear)return 1;if(!this.Gt)return 0;if(await this.loadComponent(this.Gt),!this.Yt)return 0;const component=this.Yt;return component.ds?component.ds(this.Xt,this.Qt):1}async ps(){if(this.clear)return 1;if(!this.Yt)return 0;if(this.Yt.ps){const t=(function(t,i,h){const e=s(i),n=s(t),r=Object.assign({},e.t,n.t),o=[...e.list,...n.list];if(o.length&&h&&h.length)for(const t of h)r[t]=o.shift();let l;return o.length&&Object.keys(r).length&&(r["vs"]=o.splice(0,o.length)),{ws:r,ms:o,gs:l=o.length?o:r}})(this.Kt,this.Xt._,this.Gt.t);this.Xt.t=t.ws,this.Xt.ms=t.ms,await this.Yt.ps(t.gs,this.Xt,this.Qt),this.ss=0}return this.$s(this.Yt),1}async ys(){return this.component&&(this.component.bs&&await this.component.bs(this.Qt,this.Xt),this.Yt||(this.Os(this.component),this.Cs(this.component),this.Es(this.component))),this.Yt&&(this.component&&(this.Os(this.component),this.Cs(this.component),this.Es(this.component)),this.addComponent(this.Yt),this.content=this.Gt,this.t=this.Kt,this.Qt=this.Xt,this.component=this.Yt),this.clear&&(this.content=this.t=this.component=null,this.Qt=this.Xt),this.Gt=this.Kt=this.Xt=this.Yt=null,1}js(){this.ts=null}async Rs(){this.ss&&await this.Yt.bs(),this.ts&&Object.assign(this,this.ts)}description(t=0){if(this.content){const component=this.ns(this.content),s=this.scope?this.router.bt.ks:"",i=this.t?this.router.bt.t+this.t:"";if(t||s.length||this.options.Ps)return`${component}${this.router.bt.viewport}${this.name}${s}${i}`;const h={};return h[component]=component,this.Wt.Ss(h)?`${component}${i}`:`${component}${this.router.bt.viewport}${this.name}${s}${i}`}}Hs(t=0){return[this.Wt.Vs(t),this.description(t)].filter(value=>value&&value.length).join(this.router.bt.scope)}xs(component){let t=this.options.ls||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}Ns(component){if("-"===component||null===component)return 1;let t=this.options.ls;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}As(t){this.component&&this.component.Is(t)}Ts(t){this.component&&this.component.qs(t)}_s(t){this.component&&this.component.Fs(t)}Js(t){this.component&&this.component.Ls(t)}ns(component){return null===component?null:"string"==typeof component?component:component.description.name}es(component){if(null===component)return null;if("string"!=typeof component)return component;{const t=this.context||this.router.dt,s=t.get(kernel.IContainer).zs(runtime.CustomElementResource.Ds(component));return null!==s?s.Ms(t.get(kernel.IContainer)).Us:null}}Bs(component){if(null===component)return null;component=this.ns(component);const t=this.context||this.router.dt;return"string"!=typeof component?t.get(kernel.IContainer).get(component):t.get(kernel.IContainer).get(runtime.CustomElementResource.Ds(component))}os(){this.options={},this.content=null,this.t=null,this.Qt=null,this.component=null}async loadComponent(component){await this.Ws(),this.Yt=this.Bs(component),this.Yt.Gs(0,this.context||this.router.dt,this.Bt)}Es(component){}$s(component){component.Is(2560,null)}Cs(component){component.Ls(5120)}addComponent(component){component.qs(512)}Os(component){component.Fs(1024)}async Ws(){return this.Bt?Promise.resolve():new Promise(t=>{this.Zt=t})}}class Scope{constructor(router,t,s,i){this.router=router,this.Bt=t,this.context=s,this.parent=i,this.viewport=null,this.children=[],this.Ks={},this.Qs={},this.Xs=null,this.parent&&this.parent.Ys(this)}Ss(t){const s=[];let i=0;t&&(this.Xs={},this.Qs={}),this.Xs=Object.assign({},this.Ks,this.Xs);for(const s in t){const parts=s.split(this.router.bt.scope),t=parts.shift();this.Qs[t]||(this.Qs[t]=[]),this.Qs[t].push(parts)}for(const h in this.Qs){const e=h.split(this.router.bt.t),component=e.shift().split(this.router.bt.viewport).shift(),n=component+(e.length?this.router.bt.t+e.join(this.router.bt.t):"");for(const name in this.Xs){const e=this.Xs[name];if(e&&e.xs(component)){const r=this.Zs(t,this.Qs,h,n,e);s.push(...r.ti),i=i||r.si,this.Xs[name]=null,Reflect.deleteProperty(this.Qs,h);break}}}for(const h in this.Qs){const e=h.split(this.router.bt.t),parts=e.shift().split(this.router.bt.viewport),component=parts.shift(),n=component+(e.length?this.router.bt.t+e.join(this.router.bt.t):"");let name=parts.shift();if(!name||!name.length||name.startsWith("?"))continue;let r=0;name.endsWith(this.router.bt.ks)&&(r=1,name=name.substring(0,name.length-1)),this.Ks[name]||(this.ii(name,null,null,{scope:r,Ps:1}),this.Xs[name]=this.Ks[name]);const o=this.Xs[name];if(o&&o.Ns(component)){const e=this.Zs(t,this.Qs,h,n,o);s.push(...e.ti),i=i||e.si,this.Xs[name]=null,Reflect.deleteProperty(this.Qs,h)}}for(const h in this.Qs){const e=h.split(this.router.bt.t),component=e.shift().split(this.router.bt.viewport).shift(),n=component+(e.length?this.router.bt.t+e.join(this.router.bt.t):""),r=[];for(const name in this.Xs){const t=this.Xs[name];t&&t.Ns(component)&&r.push(t)}if(1===r.length){const e=r.shift(),o=this.Zs(t,this.Qs,h,n,e);s.push(...o.ti),i=i||o.si,this.Xs[e.name]=null,Reflect.deleteProperty(this.Qs,h);break}}if(i=i||Object.keys(this.Qs).length>0,!t)for(const t of this.children){const h=t.Ss();s.push(...h.ti),i=i||h.si}return{ti:s,si:i}}Zs(t,s,i,component,h){const e=[{component,viewport:h}];let n=0;if(s[i].length){const r=h.scope||h.Wt;for(const h of s[i])if(h.length){const s=h.join(this.router.bt.scope),o={};o[s]=t[i+this.router.bt.scope+s];const l=r.Ss(o);e.push(...l.ti),n=n||l.si}}return{ti:e,si:n}}ii(name,t,s,i){let h=this.Ks[name];if(!h){let e;i.scope&&(e=new Scope(this.router,t,s,this),this.router.hi.push(e)),h=this.Ks[name]=new m(this.router,name,t,s,this,e,i)}return(t||s)&&h.rs(t,s,i),h}ei(t,s,i){return(!s&&!i||t.remove(s,i))&&(t.scope&&this.router.ni(t.scope),Reflect.deleteProperty(this.Ks,t.name)),Object.keys(this.Ks).length}ni(){for(const t of this.children)t.ni();for(const t in this.Ks)this.router.ei(this.Ks[t],null,null)}ri(t){return t.ds().then(()=>t.ys())}Ys(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}oi(t=0,s=0){const i=[];for(const h in this.Ks){const e=this.Ks[h];(e.options.as||e.options.cs&&!t)&&!s||i.push(e.Hs(t))}for(const s of this.children)i.push(...s.oi(t));return i.filter(value=>value&&value.length)}li(){const t=[];for(const s in this.Ks)t.push(this.Ks[s]);for(const s of this.children)t.push(...s.li());return t}Vs(t=0){if(!this.Bt||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.ci(this.context.get(kernel.IContainer).parent);for(;i&&i.Wt===this.parent;)s.unshift(i.description(t)),i=this.ci(i.context.get(kernel.IContainer).parent);return s.unshift(this.parent.Vs(t)),s.filter(value=>value&&value.length).join(this.router.bt.scope)}ci(t){const s=Object.values(this.Ks);for(;t;){const i=s.find(s=>s.context.get(kernel.IContainer)===t);if(i)return i;t=t.parent}return null}}class g{constructor(t){this.dt=t,this.Ks={},this.hi=[],this.ai={},this.Ot=[],this.ui=[],this.D=0,this.fi=0,this.di=[],this.pi=null,this.vi=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substring(1)),!s.startsWith("/")){const i=this.wi(t.anchor).Vs();i&&(s=`/${i}${this.bt.scope}${s}`)}this.mi.Y(s)}),this.mi=new h,this.gi=new e}U(t){if(this.D)throw Error("Router has already been activated.");return this.D=1,this.options=Object.assign({J:t=>{this.$i(t)}},t),this.bt=Object.assign({viewport:"@",jt:"+",scope:"/",ks:"!",t:"=",add:"+",clear:"-",action:"."},this.options.bt),this.gi.U({J:this.vi}),this.mi.U(this.options).catch(t=>{throw t})}B(){if(!this.D)throw Error("Router has not been activated.");this.gi.B(),this.mi.B()}$i(t){this.di.push(t),this.yi().catch(t=>{throw t})}async yi(){if(null!==this.pi||!this.di.length)return Promise.resolve();const t=this.di.shift();if(this.pi=t,this.options.bi&&this.options.bi(t),t.j)return this.pi=null,Promise.resolve();let i=0,h=0;(t.I||t.A)&&t.q&&(t.path=t.q,h=1);let e=t.path;this.options.Oi&&!h&&(e=this.options.Oi(e,this),Array.isArray(e)&&(e=this.Ci(e))),(e===this.bt.clear||e.startsWith(this.bt.clear+this.bt.add))&&(i=1,e.startsWith(this.bt.clear)&&(e=e.substring(1)));const n=s(t._);t.t=n.t,t.ms=n.list;const r=this.Ei(e);if(!r&&!Object.keys(r).length&&!i)return this.pi=null,Promise.resolve();this.ji();const o=i?this.Ri.li().filter(value=>null!==value.component):[],l=this.Ri.li().filter(value=>value.options.default&&null===value.component),c=[];let{ti:a,si:u}=this.Ri.Ss(r),f=100;for(;a.length||u||l.length;){if(!f--)throw Error("Failed to resolve all viewports");const s=[];for(const i of a){const{component,viewport:h}=i;h.hs(component,t)&&s.push(h);const e=o.findIndex(value=>value===h);0>e||o.splice(e,1);const n=l.findIndex(value=>value===h);0>n||l.splice(n,1)}for(const i of o)i.hs(this.bt.clear,t)&&s.push(i);let i;for(;i=l.shift();)i.hs(i.options.default,t)&&s.push(i);!s.length&&this.fi&&(this.mi.cancel(),this.fi=0);let h=await Promise.all(s.map(value=>value.fs()));if(h.findIndex(value=>0==value)>=0)return this.mi.cancel(),this.pi=null,Promise.resolve();if((h=await Promise.all(s.map(async value=>{const t=await value.ds();return"boolean"==typeof t?t?value.ps():0:1}))).some(t=>0==t))return this.mi.cancel(),this.pi=null,Promise.resolve();await Promise.all(s.map(value=>value.ys())),c.push(...s);const e=this.Ri.Ss();let n;for(a=[];n=this.ui.shift();)e.ti.find(value=>value.viewport===n.viewport)||a.push(n);a=[...a,...e.ti],u=e.si}this.ki(t),!t.T&&c.every(t=>t.options.as)&&this.mi.pop().catch(t=>{throw t}),c.forEach(t=>{t.js()}),this.pi=null,this.di.length&&this.yi().catch(t=>{throw t})}us(t,component){this.pi&&this.ui.push({viewport:t,component})}Ei(t){const s={};t.startsWith("/")&&(t=t.substring(1));const i=t.split(this.bt.jt);let h=0;for(;i.length;){const t=i.shift().split(this.bt.scope),parts=t.pop().split(this.bt.viewport),component=parts[0];t.push(parts.length?parts.join(this.bt.viewport):`?${h++}`);const name=t.join(this.bt.scope);component&&(s[name]=component)}return s}Pi(t){return this.ji(),this.wi(t)}ii(name,t,s,i){return this.Pi(t).ii(name,t,s,i)}ei(t,s,i){const h=t.Wt;h.ei(t,s,i)||this.ni(h)}ni(t){if(t!==this.Ri){t.ni();const s=this.hi.indexOf(t);0>s||this.hi.splice(s,1)}}W(t,s,i){"string"==typeof t&&this.mi.W(t,s,i)}replace(t,s,i){"string"==typeof t&&this.mi.replace(t,s,i)}refresh(){this.mi.refresh()}back(){this.mi.back()}forward(){this.mi.forward()}Ci(t){const s=[];for(const i of t){let t=i.component;if(i.viewport&&(t+=this.bt.viewport+i.viewport),i.t)for(const s in i.t)t+=this.bt.t+i.t[s];s.push(t)}return s.join(this.bt.jt)}Si(t){const s=[],i=t.split(this.bt.jt);for(const t of i){let component,i,h;const[e,n]=t.split(this.bt.viewport);void 0===n?[component,h]=e.split(this.bt.t):(component=e,[i,h]=n.split(this.bt.t));const r={component};i&&(r.viewport=i),h&&(r.t={id:h}),s.push(r)}return s}Hi(name,t){const s=this.Vi(name);s&&(s.Rt=[]),this.xi(name,t)}xi(name,t){let s=this.ai[name];s||(s=this.ai[name]=new r(this,name)),s.kt(t)}Vi(name){return this.ai[name]}ji(){if(!this.Ri){const t=this.dt.get(runtime.Aurelia).root();this.Ri=new Scope(this,t.Ni,t.$context,null),this.hi.push(this.Ri)}}wi(t){let s=(function(t){for(;t&&!t.$customElement;)t=t.parentElement;return t})(t).$customElement.$context.get(kernel.IContainer);for(;s;){const t=this.hi.find(t=>t.context.get(kernel.IContainer)===s);if(t)return t;s=s.parent}}Ai(t){let s=t.slice().sort((t,s)=>s.split(this.bt.scope).length-t.split(this.bt.scope).length),i=[];if((s=s.map(value=>`${this.bt.scope}${value}${this.bt.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.bt.scope).length-s.split(this.bt.scope).length),i}ki(t){this.Ot=this.Ri.oi(1,1),this.Ot=this.Ai(this.Ot);let s=this.Ri.oi(),i=(s=this.Ai(s)).join(this.bt.jt);this.options.Ii&&(i=this.options.Ii(this.Si(i),this));let h=this.Ri.oi(1);(h=this.Ai(h)).unshift(this.bt.clear);const e=t._&&t._.length?`?${t._}`:"";this.mi.X(i+e,h.join(this.bt.jt)+e,t)}}g.inject=[kernel.IContainer];class ${constructor(router,t,s){this.router=router,this.Bt=t,this.Ti=s,this.name="default",this.scope=null,this.ls=null,this.default=null,this.cs=null,this.as=null,this.viewport=null}qi(t,host,parts,s){const i=this.constructor,dom=s.get(runtime.IDOM),template=this.Ti._i(dom,i.description,s,i);template.Fi=runtime.createRenderContext(dom,s,i.description.dependencies,i),template.qi(this,host,parts)}bound(){const t={scope:this.Bt.hasAttribute("scope")};this.ls&&this.ls.length&&(t.ls=this.ls),this.default&&this.default.length&&(t.default=this.default),this.Bt.hasAttribute("no-link")&&(t.cs=1),this.Bt.hasAttribute("no-history")&&(t.as=1),this.viewport=this.router.ii(this.name,this.Bt,this.$context,t)}Ji(){this.router.ei(this.viewport,this.Bt,this.$context)}As(t){this.viewport&&this.viewport.As(t)}Ts(t){this.viewport&&this.viewport.Ts(t)}_s(t){this.viewport&&this.viewport._s(t)}Js(t){this.viewport&&this.viewport.Js(t)}}$.inject=[g,runtime.INode,runtime.IRenderingEngine],i([runtime.bindable],$.prototype,"name",void 0),i([runtime.bindable],$.prototype,"scope",void 0),i([runtime.bindable],$.prototype,"usedBy",void 0),i([runtime.bindable],$.prototype,"default",void 0),i([runtime.bindable],$.prototype,"noLink",void 0),i([runtime.bindable],$.prototype,"noHistory",void 0),runtime.CustomElementResource.Li({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> </div></template>'},$),t.zi=class{constructor(router){this.router=router,this.name=null,this.Rt=null,this.level=0}get Di(){const t=this.router.Vi(this.name);return t?t.Rt:[]}active(t){return"Active"}},i([runtime.bindable],t.zi.prototype,"name",void 0),i([runtime.bindable],t.zi.prototype,"routes",void 0),i([runtime.bindable],t.zi.prototype,"level",void 0),t.zi=i([kernel.inject(g,Element),runtime.customElement({name:"au-nav",template:'<template>\n  <nav if.bind="name" class="${name}">\n    <au-nav routes.bind="navRoutes" containerless></au-nav>\n  </nav>\n  <ul if.bind="routes" class="nav-level-${level}">\n    <li repeat.for="route of routes" class="${route.active} ${route.hasChildren}">\n      <a if.bind="route.link && route.link.length" href="${route.link}">${route.title}</a>\n      <a if.bind="!route.link || !route.link.length" click.delegate="route.toggleActive()" href="">${route.title}</a>\n      <au-nav if.bind="route.children" routes.bind="route.children" level.bind="level + 1" containerless></au-nav>\n    </li>\n  </ul>\n</template>'})],t.zi),t.Ui=h,t.Mi=e,t.Bi=r,t.Wi=o,t.Gi=l,t.Ki=c,t.Qi=a,t.Xi=u,t.State=State,t.Yi=d,t.Zi=p,t.th=v,t.sh=w,t.ih=class{constructor(){this.hh=new State,this.names={},this.Rt=new Map}add(t){if(Array.isArray(t))return void t.forEach(t=>{this.add(t)});let s=this.hh;const i=[];let h="^";const e=new c,n=[],r=t.st.name;let a=1,f=t.path;"/"===f.charAt(0)&&(f=f.slice(1));const m=[],g=f.split("/");let $,y;for(let r=0,o=g.length;o>r;++r){let o=($=g[r]).match(/^:([^?]+)(\?)?$/);if(o){const[,name,optional]=o;if(-1!==name.indexOf("="))throw Error(`Parameter ${name} in route ${t} has a default value, which is not supported.`);m.push(y=new p(name,!!optional)),n.push(name),e.xt++}else if(o=$.match(/^\*(.+)$/))m.push(y=new v(o[1])),n.push(o[1]),e.Nt++;else{if(""===$){m.push(new w);continue}m.push(y=new d($,t.zt)),e.Vt++}const l=s.put(new u(null,"/",0));let c=l;y.Dt(t=>{c=c.put(t)});for(let t=0,s=i.length;s>t;t++)i[t].Jt.push(l);y.optional?(i.push(c),h+=`(?:/${y.Ut()})?`):(s=c,h+=`/${y.Ut()}`,i.length=0,a=0)}a&&(s=s.put(new u(null,"/",0)),h+="/?");const b=[new o(t.st,n)];if(this.Rt.set(t.st,new l(m,b)),r){const t=Array.isArray(r)?r:[r];for(let s=0;t.length>s;s++)t[s]in this.names||(this.names[t[s]]=new l(m,b))}for(let s=0;i.length>s;s++){const n=i[s];n.Ht=b,n.Ut=RegExp(`${h}$`,t.zt?"":"i"),n.types=e}return s.Ht=b,s.Ut=RegExp(`${h}$`,t.zt?"":"i"),s.types=e,s}eh(t){return"string"==typeof t?this.names[t]:this.Rt.get(t)}nh(t){const s=this.eh(t);if(!s)throw Error(`There is no route named ${t}`);return[...s.Ht]}rh(t){return!!this.eh(t)}Mt(t,s){const i=this.eh(t);if(!i)throw Error(`There is no route named ${t}`);const h=i.Ht[0].st;if(h.oh)return h.href;const e=Object.assign({},s),n=i.St,r={};let o="";for(let s=0,i=n.length;i>s;s++){const i=n[s];if(i instanceof w)continue;const h=i.Mt(e,r);if(null==h){if(!i.optional)throw Error(`A value is required for route parameter '${i.name}' in route '${t}'.`)}else o+="/",o+=h}"/"!==o.charAt(0)&&(o=`/${o}`);for(const t in r)Reflect.deleteProperty(e,t);const l=kernel.buildQueryString(e);return o+(l?`?${l}`:"")}lh(t){let s=[this.hh],i={},h=0,e=t;const n=e.indexOf("?");if(-1!==n){const t=e.slice(n+1);e=e.slice(0,n),i=kernel.parseQueryString(t)}"/"!==(e=decodeURI(e)).charAt(0)&&(e=`/${e}`);let r=e.length;r>1&&"/"===e.charAt(r-1)&&(e=e.slice(0,-1),h=1,--r);for(let t=0;r>t;++t){const i=[],h=e.charAt(t);if(s.forEach(t=>{t.Jt.forEach(t=>{null!==t.Ft.qt?-1!==t.Ft.qt.indexOf(h)&&i.push(t):null!==t.Ft.Tt&&-1===t.Ft.Tt.indexOf(h)&&i.push(t)})}),0===(s=i).length)break}const o=[];for(let t=0,i=s.length;i>t;t++)s[t].Ht&&o.push(s[t]);o.sort((t,s)=>{if(t.types.Nt!==s.types.Nt)return t.types.Nt-s.types.Nt;if(t.types.Nt){if(t.types.Vt!==s.types.Vt)return s.types.Vt-t.types.Vt;if(t.types.xt!==s.types.xt)return s.types.xt-t.types.xt}return t.types.xt!==s.types.xt?t.types.xt-s.types.xt:t.types.Vt!==s.types.Vt?s.types.Vt-t.types.Vt:0});const l=o[0];if(l&&l.Ht){h&&"(.+)$"===l.Ut.source.slice(-5)&&(e=`${e}/`);const t=e.match(l.Ut);let s=1;const n=[];return n.ah=i,l.Ht.forEach(i=>{const h={};i.names.forEach(name=>{h[name]=t[s++]}),n.push(new a(i.st,h,i.names.length>0))}),n}}},t.uh=g,t.Scope=Scope,t.fh=m,t.dh=$,Object.defineProperty(t,"ph",{value:1})});
