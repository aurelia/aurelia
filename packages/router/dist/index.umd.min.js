(function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("@aurelia/kernel"),require("@aurelia/runtime")):"function"==typeof define&&define.amd?define(["exports","@aurelia/kernel","@aurelia/runtime"],s):s((t=t||self).router={},t.kernel,t.runtime)})(this,function(t,kernel,runtime){"use strict";function s(t){const s={},i=[];if(!t||!t.length)return{t:s,list:i};const h=t.replace("+"," ").split("&");for(const t of h){const h=t.split("="),e=decodeURIComponent(h.shift());if(!h.length){i.push(e);continue}const value=decodeURIComponent(h.shift());s[e]=value}return{t:s,list:i}}function i(t,s,i,h){var e,n,r=arguments.length,o=3>r?s:null===h?h=Object.getOwnPropertyDescriptor(s,i):h;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,s,i,h);else for(n=t.length-1;n>=0;n--)(e=t[n])&&(o=(3>r?e(o):r>3?e(s,i,o):e(s,i))||o);return r>3&&o&&Object.defineProperty(s,i,o),o}class h{constructor(){this.s=(async t=>{await this.i(this,"popstate",[t])}),this.window=window,this.history=window.history,this.h=[],this.o=0,this.l=null,this.u=null}p(t){if(this.o)throw kernel.Reporter.error(2003);this.o=1,this.u=t,kernel.PLATFORM.v.add(this.m,this),this.window.addEventListener("popstate",this.s)}g(){this.window.removeEventListener("popstate",this.s),kernel.PLATFORM.v.remove(this.m,this),this.u=null,this.o=0}get length(){return this.history.length}get state(){return this.history.state}get $(){return this.history.$}async go(t){await this.i(this.history,"go",[t])}back(){return this.go(-1)}forward(){return this.go(1)}async pushState(t,s,i){await this.i(this.history,"pushState",[t,s,i])}async replaceState(t,s,i){await this.i(this.history,"replaceState",[t,s,i])}C(t){this.u(t)}i(t,s,i){let h;const e=new Promise(t=>{h=t});return this.h.push({target:t,O:s,t:i,resolve:h}),e}async m(t){if(!this.h.length||null!==this.l)return;this.l=this.h.shift();const s=this.l.target[this.l.O];kernel.Reporter.write(1e4,"DEQUEUE",this.l.O,this.l.t),s.apply(this.l.target,this.l.t);const i=this.l.resolve;this.l=null,i()}}class e{constructor(){this.S=(async()=>{if(null!==this.j){kernel.Reporter.write(1e4,"=== ignore path change",this.k());const t=this.j;return this.j=null,void t()}const t=this.k(),s=this.R();kernel.Reporter.write(1e4,"path changed to",t,this.P,this.H);const i={};let h,e=this.V("HistoryEntry");if(this.P&&this.P.path===t){i.N=1;const t=this.A?this.H.index:this.history.length-this.T;h=this.H,this.H=this.P,this.H.index=t,this.A?(this.q=0,this.I[this.H.index]=this.H,this.D?(i.U=1,this.D=0):this._?(i.J=1,this._=0):i.L=1,this.A=0):(this.q=1,this.I=this.I.slice(0,this.H.index),this.I.push(this.H)),await this.F({G:this.I,M:this.T,B:this.H})}else this.I=this.I||this.V("HistoryEntries")||[],this.T=this.T||this.V("HistoryOffset")||0,e||this.H?e?this.H?e.index>this.H.index?i.W=1:this.H.index>e.index&&(i.K=1):i.J=1:i.N=1:(i.N=1,i.X=1,this.T=this.history.length),e||(e={path:t,Y:null,index:this.history.length-this.T,Z:s},i.X&&(e.tt=1),this.I=this.I.slice(0,e.index),this.I.push(e),await this.F({G:this.I,M:this.T,B:e})),this.q=this.H?e.index-this.H.index:0,h=this.H,this.H=e,this.D&&(i.U=1,this.D=0);this.P=null,this.st&&this.st--,kernel.Reporter.write(1e4,"navigated",this.V("HistoryEntry"),this.I,this.V("HistoryOffset")),this.u(this.H,i,h)}),this.location=window.location,this.history=new h,this.H=null,this.I=null,this.T=null,this.it=null,this.P=null,this.options=null,this.o=0,this.q=null,this.st=null,this.D=0,this.A=0,this._=0,this.j=null}p(t){if(this.o)throw kernel.Reporter.error(0);return this.o=1,this.options=Object.assign({},t),this.history.p(this.S),Promise.resolve().then(()=>{this.ht(this.k(),1).catch(t=>{throw t})})}g(){this.history.g(),this.o=0}et(t,s,i){return this.P={path:t,Y:null,title:s,data:i},this.ht(t)}replace(t,s,i){return this.A=1,this.P={path:t,Y:null,title:s,data:i},this.ht(t,1)}nt(t,s,i){return this.st=this.q+1,this.replace(t,s,i)}async refresh(){if(this.H)return this._=1,this.replace(this.H.path,this.H.title,this.H.data)}back(){return this.history.go(-1)}forward(){return this.history.go(1)}cancel(){this.D=1;const t=this.q||this.st;return t?this.history.go(-t):this.replace(this.it.path,this.it.title,this.it.data)}async pop(){let t,s=new Promise(t=>{this.j=t});await this.history.go(-1),await s;const i=""+this.location;if(!(t=this.history.state).B.tt)return s=new Promise(t=>{this.j=t}),await this.history.go(-1),await s,this.history.pushState(t,null,i)}async F(t,value){const{pathname:s,search:i,hash:h}=this.location;let e=Object.assign({},this.history.state);return"string"==typeof t?e[t]=JSON.parse(JSON.stringify(value)):e=Object.assign({},e,JSON.parse(JSON.stringify(t))),this.history.replaceState(e,null,`${s}${i}${h}`)}V(t){return Object.assign({},this.history.state)[t]}rt(t){return this.H.title=t,this.I[this.H.index]=this.H,this.F({G:this.I,B:this.H})}ot(t,s,i){if(i.index!==this.H.index)return;const h=`#/${t}`,{pathname:e,search:n,hash:r}=this.location;if(h===r&&this.H.path===t&&this.H.Y===s)return;this.H.path=t,this.H.Y=s;const o=Object.assign({},this.history.state,{B:this.H,G:this.I});return this.history.replaceState(o,null,`${e}${n}${h}`)}lt(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get ct(){return this.I?this.I.slice(0,this.H.index+1).map(value=>value.title):[]}k(){return this.location.hash.substring(1).split("?")[0]}async ht(t,s=0){if(this.H&&this.H.path===t&&!this._)return;const{pathname:i,search:h}=this.location,e=`#${t}`;return s?(this.it=this.H,await this.history.replaceState({},null,`${i}${h}${e}`)):await this.history.pushState({},null,`${i}${h}${e}`),this.S()}R(){const t=this.location.hash.substring(1).split("?");return t.shift(),t.length>0?t.shift():""}u(t,s,i){const h=Object.assign({},t,s);h.at=i,kernel.Reporter.write(1e4,"callback",t,s),this.options.u&&this.options.u(h)}}class n{constructor(){this.o=0,this.ut=(t=>{const s=n.ft(t);s.pt&&(t.preventDefault(),this.options.u(s))}),this.document=document}static ft(t){const s={pt:0,href:null,anchor:null},i=n.dt(t.target);if(!i||!n.wt(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const h=i.getAttribute("href");return s.anchor=i,s.href=h,s.pt=1===t.which,s}static dt(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static wt(t){const s=t.getAttribute("target");return!s||s===n.window.name||"_self"===s}p(t){if(this.o)throw kernel.Reporter.error(2004);this.o=1,this.options=Object.assign({},t),this.document.addEventListener("click",this.ut,1)}g(){this.document.removeEventListener("click",this.ut,1),this.o=0}}class r{constructor(t,s){this.active="",this.vt=t,Object.assign(this,{gt:s.gt,title:s.title,children:null,yt:s.yt,active:""}),this.link=this.$t(this.gt),this.bt=s.Ct?this.$t(s.Ct):this.link,this.Et=this.vt.router.Ot.get(runtime.IObserverLocator),this.St=this.Et.jt(0,this.vt.router,"activeComponents"),this.St.subscribe(this)}get kt(){return this.children&&this.children.length?"nav-has-children":""}Rt(){this.active=this.link&&this.link.length?this.Pt():"nav-active"===this.active?"nav-active":this.Ht()?"nav-active-child":""}Pt(){const t=this.bt.split(this.vt.router.Vt.add),s=this.vt.router.Nt;for(const component of t)if(0>component.indexOf(this.vt.router.Vt.viewport)){if(0>s.findIndex(value=>value.replace(/\@[^=]*/,"")===component))return""}else if(0>s.indexOf(component))return"";return"nav-active"}At(){this.active=this.active.startsWith("nav-active")?"":"nav-active"}$t(t){return Array.isArray(t)?t.map(value=>this.xt(value)).join(this.vt.router.Vt.Tt):this.xt(t)}Ht(){if(this.children)for(const t of this.children)if(t.active.startsWith("nav-active")||t.Ht())return 1;return 0}xt(component){return component?"string"==typeof component?component:component.description?component.description.name:component.component?this.xt(component.component)+(component.viewport?`@${component.viewport}`:""):void 0:""}}class o{constructor(router,name){this.router=router,this.name=name,this.qt=[]}It(t){for(const s of t)this.Dt(this.qt,s)}Dt(t,s){const i=new r(this,s);if(t.push(i),s.children){i.children=[];for(const t of s.children)this.Dt(i.children,t)}}}class l{constructor(t,s){this.ut=t,this.names=s}}class c{constructor(t,s){this.Ut=t,this._t=s}}class a{constructor(){this.zt=0,this.Jt=0,this.Lt=0}}class u{constructor(t,s,i){this.ut=t,this.Ft=s,this.Gt=i}}class f{constructor(t,s,i){this.Mt=t,this.Bt=s,this.repeat=i}Qt(t){return this.Bt===t.Bt&&this.Mt===t.Mt}}class State{constructor(t){this.Wt=t,this.Kt=[]}put(t){let s=this.Kt.find(s=>s.Wt.Qt(t));return void 0===s&&(s=new State(t),this.Kt.push(s),t.repeat&&s.Kt.push(s)),s}}const p=/(\/|\.|\*|\+|\?|\||\(|\)|\[|\]|\{|\}|\\)/g;class d{constructor(t,s){this.name=t,this.Xt=t,this.Yt=s,this.optional=0}Zt(t){const s=this.Xt,i=s.length;let h=0,e="";if(this.Yt)for(;i>h;++h)e=s.charAt(h),t(new f(null,e,0));else for(;i>h;++h)e=s.charAt(h),t(new f(null,e.toUpperCase()+e.toLowerCase(),0))}ts(){return this.Xt.replace(p,"\\$1")}ss(t,s){return this.Xt}}class w{constructor(name,optional){this.name=name,this.optional=optional}Zt(t){t(new f("/",null,1))}ts(){return"([^/]+)"}ss(t,s){return s[this.name]=1,t[this.name]}}class v{constructor(name){this.name=name,this.optional=0}Zt(t){t(new f("",null,1))}ts(){return"(.+)"}ss(t,s){return s[this.name]=1,t[this.name]}}class m{Zt(t){}ts(){return""}ss(t,s){return""}}var g;(function(t){t[t.hs=0]="none",t[t.loaded=1]="loaded",t[t.es=2]="initialized",t[t.ns=3]="entered",t[t.rs=4]="added"})(g||(g={}));class y{constructor(t=null,s=null,i=null,h=null){this.content=t,this.t=s,this.os=i,this.component=null,this.ls=0,this.cs=0,null!==this.content&&"string"==typeof this.content&&null!==h&&(this.content=this.as(h))}us(t){return"string"==typeof t.content&&this.fs()!==t.content||"string"!=typeof t.content&&this.content!==t.content||this.t!==t.t||!this.os||this.os.Z!==t.os.Z}ps(t){return("string"==typeof t.content&&this.fs()===t.content||"string"!=typeof t.content&&this.content===t.content)&&this.t===t.t}loadComponent(t,s){return this.cs||(this.component=this.ds(t),this.component.ws(0,t,s)),this.ls=1,Promise.resolve()}vs(){1===this.ls&&(this.ls=0)}ms(){this.cs||this.component.gs(2560,null),this.ls=2}ys(t=0){2===this.ls&&(t||this.component.$s(5120),this.ls=1)}addComponent(t){if(this.component.bs(512),this.cs){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)if(t.hasAttribute("au-element-scroll")){const[s,i]=t.getAttribute("au-element-scroll").split(",");t.removeAttribute("au-element-scroll"),t.scrollTo(+i,+s)}}this.ls=4}Cs(t,s=0){if(4===this.ls){if(s){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)(t.scrollTop>0||t.scrollLeft)&&t.setAttribute("au-element-scroll",`${t.scrollTop},${t.scrollLeft}`)}this.component.Es(1024),this.ls=4}}async Os(t,s=0){switch(this.ls){case 4:this.Cs(t,s);case 3:this.component.Ss&&await this.component.Ss(),this.ls=2;case 2:this.ys(s);case 1:this.vs()}this.ls=0}fs(){return null===this.content?null:"string"==typeof this.content?this.content:this.content.description.name}as(t){if(null===this.content)return null;if("string"!=typeof this.content)return this.content;{const s=t.get(kernel.IContainer),i=s.js(runtime.CustomElementResource.ks(this.content));return null!==i?i.Ps(s).Rs:null}}ds(t){if(null===this.content)return null;const component=this.fs();return t.get(kernel.IContainer).get("string"!=typeof component?component:runtime.CustomElementResource.ks(component))}}class ${constructor(router,name,t,s,i,h,e){this.router=router,this.name=name,this.Hs=t,this.context=s,this.Vs=i,this.scope=h,this.options=e,this.clear=0,this.content=new y,this.Ns=null,this.As=null,this.xs=null,this.cache=[],this.enabled=1}Ts(t,s){let i;if(this.clear=0,"string"==typeof t)if(t===this.router.Vt.clear)this.clear=1,t=null;else{const s=t.split(this.router.Vt.t);t=s.shift(),i=s.length?s.join(this.router.Vt.t):null}if(this.Ns=new y(t,i,s,this.context),this.options.qs){const t=this.cache.find(t=>this.Ns.ps(t));t?(this.Ns=t,this.Ns.cs=1):this.cache.push(this.Ns)}return this.content.us(this.Ns)||s.J}Is(t,s,i){this.scope&&this.scope.parent&&!this.scope.viewport&&(this.scope.viewport=this),this.scope&&!this.scope.Hs&&(this.scope.Hs=t),this.Hs!==t&&(this.xs=Object.assign({},this),this.Ds(),this.Hs=t,i&&i.Us&&(this.options.Us=i.Us),i&&i.default&&(this.options.default=i.default),i&&i._s&&(this.options._s=i._s),i&&i.zs&&(this.options.zs=i.zs),i&&i.qs&&(this.options.qs=i.qs),this.As&&this.As()),this.context!==s&&(this.context=s),this.content.component||this.Ns&&this.Ns.component||!this.options.default||this.router.Js(this.options.default,this)}remove(t,s){return this.Hs===t&&this.context===s?(this.content.component&&this.content.Os(this.Hs,this.options.qs).catch(t=>{throw t}),1):0}async Ls(){if(!this.content.component)return 1;const component=this.content.component;return component.Ls?(kernel.Reporter.write(1e4,"viewport canLeave",component.Ls(this.content.os,this.Ns.os)),component.Ls(this.content.os,this.Ns.os)):1}async Fs(){if(this.clear)return 1;if(!this.Ns.content)return 0;if(await this.Gs(),await this.Ns.loadComponent(this.context,this.Hs),!this.Ns.component)return 0;const component=this.Ns.component;if(!component.Fs)return 1;const t=component.Fs(this.Ns.os,this.content.os);return kernel.Reporter.write(1e4,"viewport canEnter",t),"boolean"==typeof t?t:"string"==typeof t?[{component:t,viewport:this}]:t}async Ms(){if(kernel.Reporter.write(1e4,"Viewport enter",this.name),this.clear)return 1;if(!this.Ns.component)return 0;if(this.Ns.component.Ms){const t=(function(t,i,h){const e=s(i),n=s(t),r=Object.assign({},e.t,n.t),o=[...e.list,...n.list];if(o.length&&h&&h.length)for(const t of h)r[t]=o.shift();let l;return o.length&&Object.keys(r).length&&(r["Bs"]=o.splice(0,o.length)),{Qs:r,Ws:o,Ks:l=o.length?o:r}})(this.Ns.t,this.Ns.os.Z,this.Ns.content.t);this.Ns.os.t=t.Qs,this.Ns.os.Ws=t.Ws,await this.Ns.component.Ms(t.Ks,this.Ns.os,this.content.os),this.Ns.ls=3}return this.Ns.ms(),1}async Xs(){return kernel.Reporter.write(1e4,"Viewport loadContent",this.name),this.content.component&&(this.content.component.Ss&&await this.content.component.Ss(this.content.os,this.Ns.os),this.Ns.component||(this.content.Cs(this.Hs,this.options.qs),this.content.ys(this.options.qs),this.content.vs())),this.Ns.component&&(this.content.component&&(this.content.Cs(this.Hs,this.options.qs),this.content.ys(this.options.qs),this.content.vs()),this.Ns.addComponent(this.Hs),this.content=this.Ns),this.clear&&(this.content=new y(null,null,this.Ns.os)),this.Ns=null,1}Ys(){this.xs=null}async Zs(){await this.Ns.Os(this.Hs,this.options.qs),this.xs&&Object.assign(this,this.xs)}description(t=0){if(this.content.content){const component=this.content.fs(),s=this.scope?this.router.Vt.ti:"",i=this.content.t?this.router.Vt.t+this.content.t:"";if(t||s.length||this.options.si)return`${component}${this.router.Vt.viewport}${this.name}${s}${i}`;const h={};return h[component]=component,this.Vs.ii(h)?`${component}${i}`:`${component}${this.router.Vt.viewport}${this.name}${s}${i}`}}hi(t=0){return[this.Vs.ei(t),this.description(t)].filter(value=>value&&value.length).join(this.router.Vt.scope)}ni(component){let t=this.options.Us||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}ri(component){if("-"===component||null===component)return 1;let t=this.options.Us;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}oi(t){this.content.component&&this.content.ms()}li(t){kernel.Reporter.write(1e4,"ATTACHING viewport",this.name,this.content,this.Ns),this.enabled=1,this.content.component&&this.content.addComponent(this.Hs)}ci(t){kernel.Reporter.write(1e4,"DETACHING viewport",this.name),this.content.component&&this.content.Cs(this.Hs,this.options.qs),this.enabled=0}ai(t){this.content.component&&this.content.ys(this.options.qs)}Ds(){this.options={},this.content=new y,this.cache=[]}async Gs(){return this.Hs?Promise.resolve():new Promise(t=>{this.As=t})}}class Scope{constructor(router,t,s,i){this.router=router,this.Hs=t,this.context=s,this.parent=i,this.viewport=null,this.children=[],this.ui=[],this.fi={},this.pi=null,this.parent&&this.parent.di(this)}wi(){return this.ui.filter(t=>t.enabled).reduce((t,s)=>(t[s.name]=s,t),{})}ii(t){const s=[];let i=0;t&&(this.pi={},this.fi={}),this.pi=Object.assign({},this.wi(),this.pi);for(const s in t){const parts=s.split(this.router.Vt.scope),t=parts.shift();this.fi[t]||(this.fi[t]=[]),this.fi[t].push(parts)}for(const h in this.fi){const e=h.split(this.router.Vt.t),component=e.shift().split(this.router.Vt.viewport).shift(),n=component+(e.length?this.router.Vt.t+e.join(this.router.Vt.t):"");for(const name in this.pi){const e=this.pi[name];if(e&&e.ni(component)){const r=this.vi(t,this.fi,h,n,e);s.push(...r.mi),i=i||r.gi,this.pi[name]=null,Reflect.deleteProperty(this.fi,h);break}}}for(const h in this.fi){const e=h.split(this.router.Vt.t),parts=e.shift().split(this.router.Vt.viewport),component=parts.shift(),n=component+(e.length?this.router.Vt.t+e.join(this.router.Vt.t):"");let name=parts.shift();if(!name||!name.length||name.startsWith("?"))continue;let r=0;name.endsWith(this.router.Vt.ti)&&(r=1,name=name.substring(0,name.length-1)),this.wi()[name]||(this.yi(name,null,null,{scope:r,si:1}),this.pi[name]=this.wi()[name]);const o=this.pi[name];if(o&&o.ri(component)){const e=this.vi(t,this.fi,h,n,o);s.push(...e.mi),i=i||e.gi,this.pi[name]=null,Reflect.deleteProperty(this.fi,h)}}for(const h in this.fi){const e=h.split(this.router.Vt.t),component=e.shift().split(this.router.Vt.viewport).shift(),n=component+(e.length?this.router.Vt.t+e.join(this.router.Vt.t):""),r=[];for(const name in this.pi){const t=this.pi[name];t&&t.ri(component)&&r.push(t)}if(1===r.length){const e=r.shift(),o=this.vi(t,this.fi,h,n,e);s.push(...o.mi),i=i||o.gi,this.pi[e.name]=null,Reflect.deleteProperty(this.fi,h);break}}if(i=i||Object.keys(this.fi).length>0,!t)for(const t of this.children){const h=t.ii();s.push(...h.mi),i=i||h.gi}return{mi:s,gi:i}}vi(t,s,i,component,h){const e=[{component,viewport:h}];let n=0;if(s[i].length){const r=h.scope||h.Vs;for(const h of s[i])if(h.length){const s=h.join(this.router.Vt.scope),o={};o[s]=t[i+this.router.Vt.scope+s];const l=r.ii(o);e.push(...l.mi),n=n||l.gi}}return{mi:e,gi:n}}yi(name,t,s,i){let h=this.wi()[name];if(t&&h&&null!==h.Hs&&h.Hs!==t&&(h.enabled=0,(h=this.ui.find(s=>s.name===name&&s.Hs===t))&&(h.enabled=1)),!h){let e;i.scope&&(e=new Scope(this.router,t,s,this),this.router.$i.push(e)),h=new $(this.router,name,null,null,this,e,i),this.ui.push(h)}return(t||s)&&h.Is(t,s,i),h}bi(t,s,i){return(!s&&!i||t.remove(s,i))&&(t.scope&&this.router.Ci(t.scope),this.ui.splice(this.ui.indexOf(t),1)),Object.keys(this.ui).length}Ci(){for(const t of this.children)t.Ci();const t=this.wi();for(const name in t)this.router.bi(t[name],null,null)}Ei(t){return t.Fs().then(()=>t.Xs())}di(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}Oi(t=0,s=0){const i=[];for(const h in this.wi()){const e=this.wi()[h];(e.options.zs||e.options._s&&!t)&&!s||i.push(e.hi(t))}for(const s of this.children)i.push(...s.Oi(t));return i.filter(value=>value&&value.length)}Si(){const t=this.ui.filter(t=>t.enabled);for(const s of this.children)t.push(...s.Si());return t}ei(t=0){if(!this.Hs||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.ji(this.context.get(kernel.IContainer).parent);for(;i&&i.Vs===this.parent;)s.unshift(i.description(t)),i=this.ji(i.context.get(kernel.IContainer).parent);return s.unshift(this.parent.ei(t)),s.filter(value=>value&&value.length).join(this.router.Vt.scope)}ji(t){const s=Object.values(this.wi());for(;t;){const i=s.find(s=>s.context.get(kernel.IContainer)===t);if(i)return i;t=t.parent}return null}}class b{constructor(t){this.Ot=t,this.$i=[],this.ki={},this.Nt=[],this.Ri=[],this.o=0,this.Pi=0,this.Hi=[],this.Vi=null,this.Ni=null,this.Ai=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substring(1)),!s.startsWith("/")){const i=this.xi(t.anchor).ei();i&&(s=`/${i}${this.Vt.scope}${s}`)}this.Ti.lt(s)}),this.Ti=new e,this.qi=new n}get Ii(){return null!==this.Vi}p(t){if(this.o)throw kernel.Reporter.error(2001);return this.o=1,this.options=Object.assign({u:t=>{this.Di(t)}},t),this.Vt=Object.assign({viewport:"@",Tt:"+",scope:"/",ti:"!",t:"=",add:"+",clear:"-",action:"."},this.options.Vt),this.qi.p({u:this.Ai}),this.Ti.p(this.options).catch(t=>{throw t})}g(){if(!this.o)throw kernel.Reporter.error(2e3);this.qi.g(),this.Ti.g()}Di(t){this.Hi.push(t),this.Ui().catch(t=>{throw t})}async Ui(){if(null!==this.Vi||!this.Hi.length)return Promise.resolve();const t=this.Hi.shift();if(this.Vi=t,this.options._i&&this.options._i(t),t.U)return this.Vi=null,this.Ui();let i=0,h=0;(t.K||t.W)&&t.Y&&(t.path=t.Y,h=1);let e=t.path;this.options.zi&&!h&&(e=this.options.zi(e,this),Array.isArray(e)&&(e=this.Ji(e))),(e===this.Vt.clear||e.startsWith(this.Vt.clear+this.Vt.add))&&(i=1,e.startsWith(this.Vt.clear)&&(e=e.substring(1)));const n=s(t.Z);t.t=n.t,t.Ws=n.list;const r=this.Li(e);if(!r&&!Object.keys(r).length&&!i)return this.Vi=null,this.Ui();const o=i?this.Si().filter(value=>null!==value.content.component):[],l=this.Si().filter(value=>value.options.default&&null===value.content.component),c=[];let{mi:a,gi:u}=this.Fi.ii(r),f=100;for(;a.length||u||l.length;){if(!f--)throw kernel.Reporter.error(2002);const s=[];for(const i of a){const{component,viewport:h}=i;h.Ts(component,t)&&s.push(h);const e=o.findIndex(value=>value===h);0>e||o.splice(e,1);const n=l.findIndex(value=>value===h);0>n||l.splice(n,1)}for(const i of o)i.Ts(this.Vt.clear,t)&&s.push(i);let i;for(;i=l.shift();)i.Ts(i.options.default,t)&&s.push(i);if(!s.length&&this.Pi){const i=this.Gi([...s,...c],t);return this.Pi=0,await this.Ui(),i}let h=await Promise.all(s.map(value=>value.Ls()));if(h.findIndex(value=>0==value)>=0)return this.Gi([...s,...c],t);if((h=await Promise.all(s.map(async value=>{const t=await value.Fs();if("boolean"==typeof t)return t?value.Ms():0;for(const s of t)this.Js(s.component,s.viewport);return value.Zs().catch(t=>{throw t}),1}))).some(t=>0==t))return this.Gi([...s,...c],t);for(const t of s)c.find(value=>value===t)||c.push(t);const e=this.Fi.ii();let n;for(a=[];n=this.Ri.shift();)e.mi.find(value=>value.viewport===n.viewport)||a.push(n);a=[...a,...e.mi],u=e.gi}await Promise.all(c.map(value=>value.Xs())),await this.Mi(t),t.X||t.Bi||!c.every(t=>t.options.zs)||await this.Ti.pop(),c.forEach(t=>{t.Ys()}),this.Ni=this.Vi,this.Ni.Bi&&(this.Ni.Bi=0),this.Vi=null,this.Ui().catch(t=>{throw t})}Js(component,t){this.Vi?("string"==typeof t&&(t=this.Si().find(s=>s.name===t)),this.Ri.push({viewport:t,component})):this.Ni&&(this.Hi.unshift({path:"",Y:"",Bi:1}),this.Ui().catch(t=>{throw t}))}Li(t){const s={};t.startsWith("/")&&(t=t.substring(1));const i=t.split(this.Vt.Tt);let h=0;for(;i.length;){const t=i.shift().split(this.Vt.scope),parts=t.pop().split(this.Vt.viewport),component=parts[0];t.push(parts.length?parts.join(this.Vt.viewport):`?${h++}`);const name=t.join(this.Vt.scope);component&&(s[name]=component)}return s}Qi(t){return this.Wi(),this.xi(t)}yi(name,t,s,i){return kernel.Reporter.write(1e4,"Viewport added",name,t),this.Qi(t).yi(name,t,s,i)}bi(t,s,i){const h=t.Vs;h.bi(t,s,i)||this.Ci(h)}Si(){return this.Wi(),this.Fi.Si()}Ci(t){if(t!==this.Fi){t.Ci();const s=this.$i.indexOf(t);0>s||this.$i.splice(s,1)}}et(t,s,i){if("string"==typeof t)return this.Ti.et(t,s,i)}replace(t,s,i){if("string"==typeof t)return this.Ti.replace(t,s,i)}refresh(){return this.Ti.refresh()}back(){return this.Ti.back()}forward(){return this.Ti.forward()}Ji(t){const s=[];for(const i of t){let t=i.component;if(i.viewport&&(t+=this.Vt.viewport+i.viewport),i.t)for(const s in i.t)t+=this.Vt.t+i.t[s];s.push(t)}return s.join(this.Vt.Tt)}Ki(t){const s=[],i=t.split(this.Vt.Tt);for(const t of i){let component,i,h;const[e,n]=t.split(this.Vt.viewport);void 0===n?[component,h]=e.split(this.Vt.t):(component=e,[i,h]=n.split(this.Vt.t));const r={component};i&&(r.viewport=i),h&&(r.t={id:h}),s.push(r)}return s}Xi(name,t){const s=this.Yi(name);s&&(s.qt=[]),this.Zi(name,t)}Zi(name,t){let s=this.ki[name];s||(s=this.ki[name]=new o(this,name)),s.It(t)}Yi(name){return this.ki[name]}async Gi(t,s){t.forEach(t=>{t.Zs().catch(t=>{throw t})}),s.N?await this.Ti.pop():await this.Ti.cancel(),this.Vi=null,this.Ui().catch(t=>{throw t})}Wi(){if(!this.Fi){const t=this.Ot.get(runtime.Aurelia).root();this.Fi=new Scope(this,t.th,t.$context,null),this.$i.push(this.Fi)}}xi(t){let s=(function(t){for(;t&&!t.$customElement;)t=t.parentElement;return t})(t).$customElement.$context.get(kernel.IContainer);for(;s;){const t=this.$i.find(t=>t.context.get(kernel.IContainer)===s);if(t)return t;s=s.parent}}sh(t){let s=t.slice().sort((t,s)=>s.split(this.Vt.scope).length-t.split(this.Vt.scope).length),i=[];if((s=s.map(value=>`${this.Vt.scope}${value}${this.Vt.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.Vt.scope).length-s.split(this.Vt.scope).length),i}Mi(t){this.Nt=this.Fi.Oi(1,1),this.Nt=this.sh(this.Nt);let s=this.Fi.Oi(),i=(s=this.sh(s)).join(this.Vt.Tt);this.options.ih&&(i=this.options.ih(this.Ki(i),this));let h=this.Fi.Oi(1);(h=this.sh(h)).unshift(this.Vt.clear);const e=t.Z&&t.Z.length?`?${t.Z}`:"";return this.Ti.ot(i+e,h.join(this.Vt.Tt)+e,t)}}b.inject=[kernel.IContainer];class C{constructor(router,t,s){this.router=router,this.Hs=t,this.hh=s,this.name="default",this.scope=null,this.Us=null,this.default=null,this._s=null,this.zs=null,this.qs=null,this.viewport=null}eh(t,host,parts,s){const i=this.constructor,dom=s.get(runtime.IDOM),template=this.hh.nh(dom,i.description,s,i);template.rh=runtime.createRenderContext(dom,s,i.description.dependencies,i),template.eh(this,host,parts)}bound(){this.connect()}oh(){this.disconnect()}connect(){const t={scope:this.Hs.hasAttribute("scope")};this.Us&&this.Us.length&&(t.Us=this.Us),this.default&&this.default.length&&(t.default=this.default),this.Hs.hasAttribute("no-link")&&(t._s=1),this.Hs.hasAttribute("no-history")&&(t.zs=1),this.Hs.hasAttribute("stateful")&&(t.qs=1),this.viewport=this.router.yi(this.name,this.Hs,this.$context,t)}disconnect(){this.router.bi(this.viewport,this.Hs,this.$context)}oi(t){this.viewport&&this.viewport.oi(t)}li(t){this.viewport&&this.viewport.li(t)}ci(t){this.viewport&&this.viewport.ci(t)}ai(t){this.viewport&&this.viewport.ai(t)}}C.inject=[b,runtime.INode,runtime.IRenderingEngine],i([runtime.bindable],C.prototype,"name",void 0),i([runtime.bindable],C.prototype,"scope",void 0),i([runtime.bindable],C.prototype,"usedBy",void 0),i([runtime.bindable],C.prototype,"default",void 0),i([runtime.bindable],C.prototype,"noLink",void 0),i([runtime.bindable],C.prototype,"noHistory",void 0),i([runtime.bindable],C.prototype,"stateful",void 0),runtime.CustomElementResource.lh({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> </div></template>'},C),t.ah=class{constructor(router){this.router=router,this.name=null,this.qt=null,this.level=0}get uh(){const t=this.router.Yi(this.name);return t?t.qt:[]}active(t){return"Active"}},i([runtime.bindable],t.ah.prototype,"name",void 0),i([runtime.bindable],t.ah.prototype,"routes",void 0),i([runtime.bindable],t.ah.prototype,"level",void 0),t.ah=i([kernel.inject(b,Element),runtime.customElement({name:"au-nav",template:'<template>\n  <nav if.bind="name" class="${name}">\n    <au-nav routes.bind="navRoutes" containerless></au-nav>\n  </nav>\n  <ul if.bind="routes" class="nav-level-${level}">\n    <li repeat.for="route of routes" class="${route.active} ${route.hasChildren}">\n      <a if.bind="route.link && route.link.length" href="${route.link}">${route.title}</a>\n      <a if.bind="!route.link || !route.link.length" click.delegate="route.toggleActive()" href="">${route.title}</a>\n      <au-nav if.bind="route.children" routes.bind="route.children" level.bind="level + 1" containerless></au-nav>\n    </li>\n  </ul>\n</template>'})],t.ah),t.fh=e,t.ph=n,t.dh=o,t.wh=h,t.vh=l,t.mh=c,t.gh=a,t.yh=u,t.$h=f,t.State=State,t.bh=d,t.Ch=w,t.Eh=v,t.Oh=m,t.Sh=class{constructor(){this.jh=new State,this.names={},this.qt=new Map}add(t){if(Array.isArray(t))return void t.forEach(t=>{this.add(t)});let s=this.jh;const i=[];let h="^";const e=new a,n=[],r=t.ut.name;let o=1,u=t.path;"/"===u.charAt(0)&&(u=u.slice(1));const p=[],g=u.split("/");let y,$;for(let r=0,l=g.length;l>r;++r){let l=(y=g[r]).match(/^:([^?]+)(\?)?$/);if(l){const[,name,optional]=l;if(-1!==name.indexOf("="))throw Error(`Parameter ${name} in route ${t} has a default value, which is not supported.`);p.push($=new w(name,!!optional)),n.push(name),e.Jt++}else if(l=y.match(/^\*(.+)$/))p.push($=new v(l[1])),n.push(l[1]),e.Lt++;else{if(""===y){p.push(new m);continue}p.push($=new d(y,t.Yt)),e.zt++}const c=s.put(new f(null,"/",0));let a=c;$.Zt(t=>{a=a.put(t)});for(let t=0,s=i.length;s>t;t++)i[t].Kt.push(c);$.optional?(i.push(a),h+=`(?:/${$.ts()})?`):(s=a,h+=`/${$.ts()}`,i.length=0,o=0)}o&&(s=s.put(new f(null,"/",0)),h+="/?");const b=[new l(t.ut,n)];if(this.qt.set(t.ut,new c(p,b)),r){const t=Array.isArray(r)?r:[r];for(let s=0;t.length>s;s++)t[s]in this.names||(this.names[t[s]]=new c(p,b))}for(let s=0;i.length>s;s++){const n=i[s];n._t=b,n.ts=RegExp(`${h}$`,t.Yt?"":"i"),n.types=e}return s._t=b,s.ts=RegExp(`${h}$`,t.Yt?"":"i"),s.types=e,s}kh(t){return"string"==typeof t?this.names[t]:this.qt.get(t)}Rh(t){const s=this.kh(t);if(!s)throw Error(`There is no route named ${t}`);return[...s._t]}Ph(t){return!!this.kh(t)}ss(t,s){const i=this.kh(t);if(!i)throw Error(`There is no route named ${t}`);const h=i._t[0].ut;if(h.Hh)return h.href;const e=Object.assign({},s),n=i.Ut,r={};let o="";for(let s=0,i=n.length;i>s;s++){const i=n[s];if(i instanceof m)continue;const h=i.ss(e,r);if(null==h){if(!i.optional)throw Error(`A value is required for route parameter '${i.name}' in route '${t}'.`)}else o+="/",o+=h}"/"!==o.charAt(0)&&(o=`/${o}`);for(const t in r)Reflect.deleteProperty(e,t);const l=kernel.buildQueryString(e);return o+(l?`?${l}`:"")}Vh(t){let s=[this.jh],i={},h=0,e=t;const n=e.indexOf("?");if(-1!==n){const t=e.slice(n+1);e=e.slice(0,n),i=kernel.parseQueryString(t)}"/"!==(e=decodeURI(e)).charAt(0)&&(e=`/${e}`);let r=e.length;r>1&&"/"===e.charAt(r-1)&&(e=e.slice(0,-1),h=1,--r);for(let t=0;r>t;++t){const i=[],h=e.charAt(t);if(s.forEach(t=>{t.Kt.forEach(t=>{null!==t.Wt.Bt?-1!==t.Wt.Bt.indexOf(h)&&i.push(t):null!==t.Wt.Mt&&-1===t.Wt.Mt.indexOf(h)&&i.push(t)})}),0===(s=i).length)break}const o=[];for(let t=0,i=s.length;i>t;t++)s[t]._t&&o.push(s[t]);o.sort((t,s)=>{if(t.types.Lt!==s.types.Lt)return t.types.Lt-s.types.Lt;if(t.types.Lt){if(t.types.zt!==s.types.zt)return s.types.zt-t.types.zt;if(t.types.Jt!==s.types.Jt)return s.types.Jt-t.types.Jt}return t.types.Jt!==s.types.Jt?t.types.Jt-s.types.Jt:t.types.zt!==s.types.zt?s.types.zt-t.types.zt:0});const l=o[0];if(l&&l._t){h&&"(.+)$"===l.ts.source.slice(-5)&&(e=`${e}/`);const t=e.match(l.ts);let s=1;const n=[];return n.Nh=i,l._t.forEach(i=>{const h={};i.names.forEach(name=>{h[name]=t[s++]}),n.push(new u(i.ut,h,i.names.length>0))}),n}}},t.Ah=b,t.Scope=Scope,t.xh=$,t.Th=C,Object.defineProperty(t,"qh",{value:1})});
